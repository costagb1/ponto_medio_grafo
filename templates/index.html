<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Ponto Médio entre Cidades (A, B e C)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
    }
    h1 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f9f9f9;
      white-space: pre-wrap;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
    #map {
      height: 400px;
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Ponto Médio entre Cidades (A, B e C)</h1>

  <form id="midpoint-form">
    <label for="cityA">Cidade A:</label>
    <input
      type="text"
      id="cityA"
      name="cityA"
      placeholder="Ex: Av Atlântica, Rio de Janeiro Brazil"
      required
    />

    <label for="cityB">Cidade B:</label>
    <input
      type="text"
      id="cityB"
      name="cityB"
      placeholder="Ex: Aeroporto Santos Dumont, Rio de Janeiro Brazil"
      required
    />

    <label for="cityC">Cidade C:</label>
    <input
      type="text"
      id="cityC"
      name="cityC"
      placeholder="Ex: Niteroi, Rio de Janeiro Brazil"
      required
    />

    <button type="submit">Calcular ponto médio</button>
  </form>

  <div id="error" class="error"></div>
  <div id="result" class="result"></div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const form = document.getElementById("midpoint-form");
    const errorDiv = document.getElementById("error");
    const resultDiv = document.getElementById("result");

    let map;
    let markersLayer;

    function initMap() {
      map = L.map("map").setView([0, 0], 2);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    document.addEventListener("DOMContentLoaded", initMap);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorDiv.textContent = "";
      resultDiv.textContent = "Calculando...";

      const cityA = document.getElementById("cityA").value;
      const cityB = document.getElementById("cityB").value;
      const cityC = document.getElementById("cityC").value;

      try {
        const resp = await fetch("/api/midpoint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cityA, cityB, cityC }),
        });

        const data = await resp.json();
        console.log("Resposta da API:", data);

        if (!resp.ok) {
          errorDiv.textContent = data.error || "Erro desconhecido.";
          resultDiv.textContent = "";
          return;
        }

        // --------- Monta texto amigável ----------
        const lines = [];

        lines.push("Cidade A:");
        lines.push("  Input: " + data.cityA.input);
        lines.push("  Lat: " + data.cityA.lat.toFixed(6));
        lines.push("  Lon: " + data.cityA.lon.toFixed(6));
        lines.push("");

        lines.push("Cidade B:");
        lines.push("  Input: " + data.cityB.input);
        lines.push("  Lat: " + data.cityB.lat.toFixed(6));
        lines.push("  Lon: " + data.cityB.lon.toFixed(6));
        lines.push("");

        lines.push("Cidade C:");
        lines.push("  Input: " + data.cityC.input);
        lines.push("  Lat: " + data.cityC.lat.toFixed(6));
        lines.push("  Lon: " + data.cityC.lon.toFixed(6));
        lines.push("");

        lines.push("Ponto Médio (centróide de A, B e C):");
        lines.push("  Lat: " + data.midpoint.lat.toFixed(6));
        lines.push("  Lon: " + data.midpoint.lon.toFixed(6));

        const rev = data.midpoint.reverse || {};
        const revLocality = rev.locality || "";
        const revCountry = rev.country || "";
        const revPostal = rev.postalCode || "";
        const revStr = [revLocality, revPostal, revCountry].filter(Boolean).join(", ");
        if (revStr) {
          lines.push("  Local aproximado: " + revStr);
        }
        lines.push("");

        lines.push("Distâncias (km) do ponto médio:");
        lines.push("  A -> M: " + data.distances_km.A_to_M.toFixed(2) + " km");
        lines.push("  B -> M: " + data.distances_km.B_to_M.toFixed(2) + " km");
        lines.push("  C -> M: " + data.distances_km.C_to_M.toFixed(2) + " km");
        lines.push("");

        lines.push("Caminhos no grafo (via M):");
        const paths = data.graph.paths;
        lines.push("  A → B: " + paths.A_to_B_via_M.join(" -> "));
        lines.push("  A → C: " + paths.A_to_C_via_M.join(" -> "));
        lines.push("  B → C: " + paths.B_to_C_via_M.join(" -> "));

        resultDiv.textContent = lines.join("\n");

        // --------- Desenha o mapa ----------
        markersLayer.clearLayers();

        const latA = data.cityA.lat;
        const lonA = data.cityA.lon;
        const latB = data.cityB.lat;
        const lonB = data.cityB.lon;
        const latC = data.cityC.lat;
        const lonC = data.cityC.lon;
        const latM = data.midpoint.lat;
        const lonM = data.midpoint.lon;

        // Segurança: garante que são números
        const coords = [latA, lonA, latB, lonB, latC, lonC, latM, lonM];
        if (coords.some((v) => typeof v !== "number" || Number.isNaN(v))) {
          console.error("Coordenadas inválidas:", coords);
          errorDiv.textContent = "Coordenadas inválidas retornadas pela API.";
          return;
        }

        const markerA = L.marker([latA, lonA]).bindPopup(
          "<b>Cidade A</b><br>" + data.cityA.input
        );
        const markerB = L.marker([latB, lonB]).bindPopup(
          "<b>Cidade B</b><br>" + data.cityB.input
        );
        const markerC = L.marker([latC, lonC]).bindPopup(
          "<b>Cidade C</b><br>" + data.cityC.input
        );
        const markerM = L.marker([latM, lonM]).bindPopup(
          "<b>Ponto Médio</b><br>" + (revStr || "Centroide entre A, B e C")
        );

        markersLayer.addLayer(markerA);
        markersLayer.addLayer(markerB);
        markersLayer.addLayer(markerC);
        markersLayer.addLayer(markerM);

        const polyline = L.polyline(
          [
            [latA, lonA],
            [latM, lonM],
            [latB, lonB],
            [latC, lonC],
          ],
          { weight: 3 }
        ).addTo(markersLayer);

        const bounds = L.latLngBounds([
          [latA, lonA],
          [latB, lonB],
          [latC, lonC],
          [latM, lonM],
        ]);
        map.fitBounds(bounds, { padding: [30, 30] });
      } catch (err) {
        console.error(err);
        errorDiv.textContent = "Erro na requisição ou no frontend.";
        resultDiv.textContent = "";
      }
    });
  </script>
</body>
</html>